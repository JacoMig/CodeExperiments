<!DOCTYPE html>
<html>
<head>
	<title>Backend Node</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	
</head>
<body>
	<header>{{> navigation}}
		<a href="/frontpage" class="linkToFront" target="_blank">Show Frontend</a>
	</header>
	<div class="main">
		<div class="menu"></div>
		<div class="content">
			<button class="addProject">Add a project</button>
			<div id="output">
				{{> projects listOfProjects=true}}
			</div>
		</div>	
	</div>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> 
	<script>
		function getMaxOfArray(numArray) {
		  return Math.max.apply(null, numArray);
		}
		$(document).ready(function(){

			let newID = 0;
			let IDs = [];
		
			
			{{#jsonData}}
				{{#each projectslist}}
					IDs.push({{this.id}});
				{{/each}}
			{{/jsonData}}	
			if( IDs.length != 0)
				newID = getMaxOfArray(IDs);
			else
				newID = 0;
			

			$('#output').on('click', '.block button', function(event){
	    		event.preventDefault();
				const _this = $(this);
				const form = _this.parent();
				const action = _this.attr('name')
	    		_this.attr("disabled", "disabled");
				const projectId = form.find('input[name="id"]').val();
				
				if(!_this.hasClass('deleteSingle')){
					const formData = new FormData(form[0]);
					
					if(action === "post"){	
						console.log('posting ajax')	
						formData.append('method','post');  
					}else if(action === "update"){
						console.log('update ajax')	
						formData.append('method','update');  
					}else if(action === "delete"){
						console.log('delete ajax')	
						formData.append('method','delete');  
					}
					
					
					$.ajax({
					    url: 'http://localhost:8000/',
					    type: 'POST',
					    data: formData,
					    mimeType: "multipart/form-data",
						contentType: false,
						cache: false,
						processData: false,
					    async: true,
					    success: function(result) {
				 	     	
				 	     	if(result === 'delete'){
				 	     		$('#project-'+projectId).remove()
				 	     	}else{
				 	     		var image = JSON.parse(result).picurl;
				 	     		form.find('img').attr('src', '/uploads/thumbs/'+image)
				 	     		/*if(action === "post")
				 	     			location.reload(true)
				 	     		location.reload(true)	*/
				 	     		
				 	     	}
				 	     	_this.removeAttr("disabled");	
				 	     	
				 	    },
				        error: function(jqXHR, textStatus, errorThrown) {
				            alert('error ' + textStatus + " " + errorThrown);
				        }
					  });
				}else{
					IDs = IDs.filter(id => id != projectId)
					form.parent().remove();
				}
	    	})

	    

			// Add Project
			$('.addProject').on('click', function(){
				newID++;
				if(IDs.length === 0)
					$(`{{> projects listOfProjects=false id="${newID}"}}`).appendTo('#output');
				else	
					$(`{{> projects listOfProjects=false id="${newID}"}}`).insertBefore("#project-"+IDs[0]);
				IDs.unshift(newID)
				console.log(IDs)
			})


		})
	</script>
</body>
</html>